@model MediClinic.Models.PhysicianAdvice

@{
    ViewData["Title"] = "Add Advice";
    Layout = "~/Views/Shared/_PhysicianLayout.cshtml";
}

<div class="card shadow-sm border-0 rounded-4">
    <div class="card-body p-4">

        <!-- Header -->
        <div class="mb-4">
            <h4 class="fw-bold mb-1">Add Medical Advice</h4>
            <small class="text-muted">
                Provide diagnosis and prescribe medicines for the patient
            </small>
        </div>

        <form asp-action="AddAdvice" method="post">

            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="ScheduleId" />

            <div asp-validation-summary="ModelOnly"
                 class="alert alert-danger rounded-3"></div>

            <!-- Advice -->
            <div class="mb-4">
                <label class="form-label fw-semibold">Medical Advice</label>
                <textarea name="Advice"
                          class="form-control rounded-3"
                          rows="3"
                          placeholder="Enter medical advice">@Model.Advice</textarea>
            </div>

            <!-- Note -->
            <div class="mb-4">
                <label class="form-label fw-semibold">Additional Notes</label>
                <textarea name="Note"
                          class="form-control rounded-3"
                          rows="2"
                          placeholder="Optional notes">@Model.Note</textarea>
            </div>

            <hr class="my-4" />

            <!-- Prescription -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-semibold mb-0">PhysicianPrescrips</h5>

                <button type="button"
                        class="btn btn-outline-primary rounded-pill px-3"
                        id="addRow">
                    + Add Medicine
                </button>
            </div>

            <div class="table-responsive">
                <table class="table align-middle" id="prescriptionTable">

                    <thead class="table-light">
                        <tr>
                            <th>Drug</th>
                            <th>Prescription</th>
                            <th>Dosage</th>
                            <th width="60"></th>
                        </tr>
                    </thead>

                    <tbody>

                        @{
                            var list = Model.PhysicianPrescrips?.ToList()
                            ?? new List<MediClinic.Models.PhysicianPrescrip>();
                        }

                        @for (int i = 0; i < list.Count; i++)
                        {
                            <tr>

                                <td>
                                    <select name="PhysicianPrescrips[@i].DrugId"
                                            class="form-select rounded-3">

                                        <option value="">-- Select Drug --</option>

                                        @foreach (var d in (SelectList)ViewBag.Drugs)
                                        {
                                            <option value="@d.Value">@d.Text</option>
                                        }

                                    </select>
                                </td>

                                <td>
                                    <input name="PhysicianPrescrips[@i].Prescription"
                                           class="form-control rounded-3"
                                           placeholder="e.g. After food" />
                                </td>

                                <td>
                                    <input name="PhysicianPrescrips[@i].Dosage"
                                           class="form-control rounded-3"
                                           placeholder="e.g. 1-0-1" />
                                </td>

                                <td>
                                    <button type="button"
                                            class="btn btn-danger btn-sm remove-row">
                                        X
                                    </button>
                                </td>

                            </tr>
                        }

                    </tbody>

                </table>
            </div>

            <div class="mt-4 text-end">
                <button type="submit"
                        class="btn btn-success rounded-pill px-4">
                    Save Advice
                </button>
            </div>

        </form>
    </div>
</div>

@section Scripts {

    <script>

        const drugOptions = `
            <option value="">-- Select Drug --</option>
            @foreach (var d in (SelectList)ViewBag.Drugs)
            {
                    <option value="@d.Value">@d.Text</option>
            }
        `;

        let index = @((Model.PhysicianPrescrips?.Count ?? 0));

        document.getElementById("addRow").addEventListener("click", function () {

            const table = document.querySelector("#prescriptionTable tbody");

            const row = `
                <tr>
                    <td>
                        <select name="PhysicianPrescrips[${index}].DrugId"
                                class="form-select rounded-3">
                            ${drugOptions}
                        </select>
                    </td>

                    <td>
                        <input name="PhysicianPrescrips[${index}].Prescription"
                               class="form-control rounded-3"
                               placeholder="e.g. After food" />
                    </td>

                    <td>
                        <input name="PhysicianPrescrips[${index}].Dosage"
                               class="form-control rounded-3"
                               placeholder="e.g. 1-0-1" />
                    </td>

                    <td>
                        <button type="button"
                                class="btn btn-danger btn-sm remove-row">
                            X
                        </button>
                    </td>
                </tr>`;

            table.insertAdjacentHTML("beforeend", row);
            index++;
        });

        document.addEventListener("click", function (e) {

            if (e.target.closest(".remove-row")) {
                e.target.closest("tr").remove();
            }

        });

    </script>

}